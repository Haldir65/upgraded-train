name: Build grpc lib on alpine docker image

on:
    workflow_dispatch:

env:
  UPLOAD_API_URL: ${{ secrets.UPLOAD_API_URL }}

jobs:
  buildGrpcLibOnAlpine:
    runs-on: ubuntu-24.04-arm
    container:
      image: docker://arm64v8/alpine:3.23  
    steps:
      -   name: Checkout
          uses: actions/checkout@v4    
              
      -   name: Install `related deps` on alpine
          run: |
            apk add --no-cache build-base cmake git ninja perl linux-headers curl zip tree
            echo "cpu core num is "
            nproc

      -   name: build grpc static binary
          env:
            UPLOAD_API_URL: ${{ secrets.UPLOAD_API_URL }}
          run: |
              sh scripts/alpine_build_lib_test.sh

      -   name: show layouts
          run: |
            tree -L 3

    
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grpc_assets
          path: grpc_install.zip
          if-no-files-found: error
          retention-days: 3 